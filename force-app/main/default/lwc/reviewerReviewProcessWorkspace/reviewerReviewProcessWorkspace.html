<template>
    <div style="position: relative;">
        <div class="workspace-header">
            <div class="slds-grid slds-gutters slds-m-bottom_small">
                <div class="slds-col search-container">
                    <div class="slds-grid slds-input-has-icon slds-input-has-icon_left">
                        <lightning-icon 
                            icon-name="utility:search" 
                            alternative-text="Search" 
                            size="x-small" 
                            class="slds-input__icon slds-input__icon_left">
                        </lightning-icon>
                        <input oninput={handleSearch} type="text" class="slds-input search-input" placeholder="Search..." />
                    </div>
                </div>
                <div class="slds-no-flex slds-align-middle slds-m-left_small slds-m-right_small">
                    <lightning-button-icon 
                        icon-name="utility:refresh" 
                        alternative-text="Refresh" 
                        title="Refresh Records"
                        onclick={handleRefreshClick}>
                    </lightning-button-icon>
                </div>
            </div>
        </div>
        <div class="reviewer-container">
            <template lwc:if={filteredProcesses.length} for:each={filteredProcesses} for:item="process">
                <div key={process.Id} class="slds-box reviewer-card">
                    <div class="slds-grid">
                        <h1 class="reviewer-title">{process.Name}</h1>
                        <div class="reviewer-tags slds-col_bump-left">
                            <span class="reviewer-tag">{process.endDateLabel}</span>
                        </div>
                    </div>

                    <div class="reviewer-body">
                        <lightning-tabset>
                            <lightning-tab label="Overview">
                                <div class="reviewer-stats">
                                    <div class="reviewer-stat slds-box">
                                        <span class="reviewer-value">{process.totalRecords}</span>
                                        <span class="reviewer-label">Total Records</span>
                                    </div>
                                    <div class="reviewer-stat slds-box">
                                        <span class="reviewer-value">{process.feedbacks.length}</span>
                                        <span class="reviewer-label">Your Pending</span>
                                    </div>
                                    <div class="reviewer-stat slds-box">
                                        <span class="reviewer-value">{process.completedFeedback}</span>
                                        <span class="reviewer-label">Your Completed</span>
                                    </div>
                                </div>

                                <button data-id={process.Id} type="submit" onclick={handleNewReviewClick} class="new-review-button slds-button slds-button_brand slds-button_stretch">
                                    Start New Review
                                </button>
                            </lightning-tab>
                            <lightning-tab lwc:if={process.feedbacks.length} label="Unfinished Reviews">
                                <div class="pending-review-container">
                                    <template for:each={process.feedbacks} for:item="feedback">
                                        <div key={feedback.Id} data-id={feedback.Id} class="pending-review-card slds-box slds-grid slds-align_absolute-center">
                                            <div class="slds-col slds-grow">
                                                <span class="pending-review-name">{feedback.Name}</span>
                                                <span class="pending-review-tag">{feedback.RecordType__c}</span>
                                            </div>
                                            <div class="slds-col">
                                                <button data-id={feedback.Id} class="continue-review-button" onclick={handleContinueReview}>Continue</button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </lightning-tab>
                        </lightning-tabset>
                    </div>
                </div>
            </template>
            <template lwc:else>
                <template lwc:if={reviewProcesses.length}>
                    <div class="slds-align_absolute-center slds-m-vertical_x-small">
                        No review processes found
                    </div>
                </template>
                <template lwc:else>
                    <div class="slds-align_absolute-center slds-m-vertical_x-small">
                        There are no active review processes
                    </div>
                </template>
            </template>
        </div>
        <lightning-spinner lwc:if={isLoading} alternative-text="Loading" size="small"></lightning-spinner>
    </div>
</template>